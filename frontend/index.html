<!DOCTYPE html>
<html lang="zh-CN">
<head lang="en">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <title>Fishteam 配置中心</title>
    <link rel="stylesheet" href="/static/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/css/font-awesome.min.css">
    <link rel="stylesheet" href="/static/css/main.css">
    <link href="/static/jsoneditor/jsoneditor.css" rel="stylesheet" type="text/css">
    <script src="static/js/jquery-1.11.0.js"></script>
    <script src="/static/js/bootstrap.js"></script>
    <script src="/static/js/angular.js"></script>
    <script src="/static/js/angular-route.js"></script>
    <script src="/static/jsoneditor/jsoneditor.js"></script>
    <script src="/static/js/vue.js"></script>
    <script src="/static/js/vue-resource.js"></script>
    <style>
        #head-wrap {
            width: 100%;
            height: 300px;
            padding-top: 50px;
            background-image: linear-gradient(30deg, rgb(2, 0, 49) 0px, rgb(109, 51, 83) 100%);
            text-align: center;
        }

        .title {
            color: #ffffff;
            font-family: "Helvetica Neue", "microsoft yahei", Helvetica, Arial, "Hiragino Sans GB", "Hiragino Sans GB W3", "WenQuanYi Micro Hei", sans-serif;
            font-size: 50px;
        }

        .app-name {
            color: #ffffff;
            font-family: "Helvetica Neue", "microsoft yahei", Helvetica, Arial, "Hiragino Sans GB", "Hiragino Sans GB W3", "WenQuanYi Micro Hei", sans-serif;
            font-size: 75px;
        }
    </style>
</head>
<body>
<!-- <div id="head-wrap">-->
<!-- <p class="app-name">ETCC</p>-->

<!-- <p class="title">欢迎来到Fishteam配置中心</p> -->
<!-- </div> -->
<!-- <div class="project-wrap"> -->
<!-- <ul> -->
<!-- <li></li> -->
<!-- </ul> -->
<!-- </div> -->

<div class="container">
    <div id="services">
        <ul>
            <li @refresh="fetch" is="service" v-for="service in services" :service-name="service"></li>
        </ul>
        <div>
            <input type="text" v-model="newServiceName">
            <button @click="addService" type="button" name="button">创建Service</button>
        </div>
    </div>
    <hr>
    <div class="json-editor">
        <div style="height: 250px" id="jsoneditor"></div>
    </div>
</div>
<template id="config">
    <li>
        <a href="#" @click="setJson">{{configName}}</a>
        <a href="#" @click="delConfig"><span>[X]</span></a>
    </li>
</template>
<template id="service">
    <li>
        <label for="">{{serviceName}}</label>
        <a @click="delService" href="#"><span>X</span></a>
        <ul>
            <li @refresh="fetch" v-for="config in configs" is="config" :service-name="serviceName" :config-name="config.name" :config-json="config.data"></li>
        </ul>
        <input type="text" name="name" v-model="newConfigName">
        <button @click="newConfig" type="button" name="button">新建配置</button>
    </li>
</template>
<script>
    var json_editor = new JSONEditor(document.getElementById('jsoneditor'),{
        modes: ['tree', 'code', 'text']
    });
    var comConfig = Vue.extend({
        props: [
            'configJson',
            'configName',
            'serviceName'
        ],
        http: {
            root: '/services'
        },
        methods: {
            'setJson': function(){
                json_editor.set(this.configJson);
            },
            'delConfig': function(){
                this.$http.delete(this.serviceName + '/configures/' + this.configName
            ,function(data, status, request){
                this.$dispatch('refresh');
            })
            }
        },
        template: '#config'
    });
    var comService = Vue.extend({
        props: [
            'serviceName'
        ],
        http: {
            root: '/services'
        },
        template: '#service',
        components: {
            'config': comConfig
        },
        methods: {
            'delService': function(){
                this.$http.delete(this.serviceName);
                this.$dispatch('refresh');
            },
            'fetch': function(){
                this.$http.get(this.serviceName + '/configures', function (data, status, request) {
                if(data['status'] == 'success'){
                    this.configs = data['data'];
                }
                else {
                    console.log('请求configs错误');
                }
                }).error(function (data, status, request) {
                    console.log('请求错误');
                })
            },
            'newConfig': function(){
                this.$http.post(this.serviceName+'/configures', {
                    "action": "create_configure",
                    "configure_name": this.newConfigName,
                    "configure": {"a":1, "b":11}
                }, function(data, status, request){
                    //
                });
                this.fetch();
                this.newConfigName = "";
            }
        },
        ready: function(){
            this.fetch();
        },
        data: function(){
            return {
                'configs': [],
                'newConfigName': ''
            };
        }
    });
    var vmServices = new Vue({
        http: {
            root: '/services',
        },
        el: '#services',
        components: {
            'service': comService
        },
        methods: {
            'fetch': function(){
                this.$http.get('', function (data, status, request) {
                if(data['status'] == 'success'){
                    this.services = data['data'];
                }
                else {
                    console.log('请求services错误');
                }
                }).error(function (data, status, request) {
                    console.log('请求错误');
                })
            },
            'addService': function(){
                this.$http.post('', {"action": "create_service",
                "service": this.newServiceName});
                this.newServiceName = '';
                this.fetch();
            }
        },
        ready: function(){
            this.fetch();
        },
        data: {
            'services': [],
            'newServiceName': ''
        }
    });
</script>
</body>
</html>
